<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>METANIT.COM</title>
</head>
<body>
    <div id="header"></div>
    <div id="container">
        <div id="login-container">
            <h2>Вход</h2>
            <label for="username">Логин:</label>
            <input type="text" id="username" />
            <br />
            <label for="password">Пароль:</label>
            <input type="password" id="password" />
            <br />
            <button id="login-button">Войти</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Mac</th>
                    <th>Position</th>
                    <th>Speed</th>
                    <th>Rental Time</th>
                    <th>Battery Level</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
        const elem = ReactDOM.createRoot(document.getElementById("header"));
        function tick() {
            elem
            .render(
              <div>
                <h2>Текущее время {new Date().toLocaleTimeString()}</h2>
              </div>
            );
          }
          setInterval(tick, 1000);
    </script>
    <script type="text/babel">
        const tableBody = document.getElementById("tableBody");
        let accessToken = ""; // Инициализируем пустой токен

        // Функция для отправки GET-запроса с токеном
        async function fetchData() {
            try {
                const response = await fetch("https://localhost:7018/Scooter", {
                    method: "GET",
                    headers: {
                        Accept: "application/json", // Здесь указывается желаемый формат ответа
                        Authorization: `Bearer ${accessToken}`,
                    },
                });

                if (!response.ok) {
                    throw new Error("Failed to fetch data");
                }

                const data = await response.json(); // Преобразование ответа в JSON

                // Очищаем существующие строки таблицы
                tableBody.innerHTML = "";

                // Добавляем строки данных в таблицу
                data.forEach((item) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                    <td>${item.mac}</td>
                    <td>${item.position}</td>
                    <td>${item.speed}</td>
                    <td>${item.rentalTime}</td>
                    <td>${item.batteryLevel}</td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error("Error fetching data:", error);
            }
        }

        // Вызываем fetchData при загрузке страницы
        fetchData();

        // Обработчик нажатия на кнопку "Войти"
        document.getElementById("login-button").addEventListener("click", async () => {
            try {
                // Получаем логин и пароль из полей ввода
                const username = document.getElementById("username").value;
                const password = document.getElementById("password").value;
				
                // Отправляем запрос на получение токена
                const tokenResponse = await fetch("http://localhost:8080/realms/TaogarSmartCloud/protocol/openid-connect/token", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                    },
                    body: `client_id=ScooterAuth&grant_type=password&username=${username}&password=${password}`,
                });
				console.log(tokenResponse);
                if (!tokenResponse.ok) {
                    throw new Error("Failed to fetch token");
                }

                const tokenData = await tokenResponse.json(); // Получаем данные токена

                // Сохраняем токен в переменной accessToken
                accessToken = tokenData.access_token;

                // Вызываем fetchData с новым токеном
                fetchData();
            } catch (error) {
                console.error("Error logging in:", error);
            }
        });
    </script>
</body>
</html>
